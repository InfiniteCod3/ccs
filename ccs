#!/usr/bin/env bash
set -euo pipefail

# Version - Read from VERSION file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CCS_VERSION="$(cat "$SCRIPT_DIR/VERSION" 2>/dev/null || echo "unknown")"

CONFIG_FILE="${CCS_CONFIG:-$HOME/.ccs/config.json}"

# Installation function for commands and skills
install_commands_and_skills() {
  local source_dir="$SCRIPT_DIR/.claude"
  local target_dir="$HOME/.claude"

  echo "┌─ Installing CCS Commands & Skills"
  echo "│  Source: $source_dir"
  echo "│  Target: $target_dir"
  echo "│"

  # Check if source directory exists
  if [[ ! -d "$source_dir" ]]; then
    echo "│"
    echo "✗ Error: Source directory not found: $source_dir"
    echo "  Make sure you're running this from the CCS repository directory."
    return 1
  fi

  # Create target directories if they don't exist
  mkdir -p "$target_dir/commands"
  mkdir -p "$target_dir/skills"

  local installed_count=0
  local skipped_count=0

  # Install commands
  if [[ -d "$source_dir/commands" ]]; then
    echo "│  Installing commands..."
    for cmd_file in "$source_dir/commands"/*.md; do
      if [[ -f "$cmd_file" ]]; then
        local cmd_name=$(basename "$cmd_file" .md)
        local target_file="$target_dir/commands/$cmd_name.md"

        if [[ -f "$target_file" ]]; then
          echo "│  │  ℹ  Skipping existing command: $cmd_name.md"
          skipped_count=$((skipped_count + 1))
        else
          if cp "$cmd_file" "$target_file"; then
            echo "│  │  ✓  Installed command: $cmd_name.md"
            installed_count=$((installed_count + 1))
          else
            echo "│  │  ✗  Failed to install command: $cmd_name.md"
          fi
        fi
      fi
    done
  else
    echo "│  ℹ  No commands directory found"
  fi

  echo "│"

  # Install skills
  if [[ -d "$source_dir/skills" ]]; then
    echo "│  Installing skills..."
    for skill_dir in "$source_dir/skills"/*; do
      if [[ -d "$skill_dir" ]]; then
        local skill_name=$(basename "$skill_dir")
        local target_skill_dir="$target_dir/skills/$skill_name"

        if [[ -d "$target_skill_dir" ]]; then
          echo "│  │  ℹ  Skipping existing skill: $skill_name"
          skipped_count=$((skipped_count + 1))
        else
          if cp -r "$skill_dir" "$target_skill_dir"; then
            echo "│  │  ✓  Installed skill: $skill_name"
            installed_count=$((installed_count + 1))
          else
            echo "│  │  ✗  Failed to install skill: $skill_name"
          fi
        fi
      fi
    done
  else
    echo "│  ℹ  No skills directory found"
  fi

  echo "└─"
  echo ""
  echo "✓ Installation complete!"
  echo "  Installed: $installed_count items"
  echo "  Skipped: $skipped_count items (already exist)"
  echo ""
  echo "You can now use the /ccs command in Claude CLI for task delegation."
  echo "Example: /ccs glm /plan 'add user authentication'"
}

# Special case: version command (check BEFORE profile detection)
if [[ $# -gt 0 ]] && [[ "${1}" == "version" || "${1}" == "--version" || "${1}" == "-v" ]]; then
  echo "CCS (Claude Code Switch) version $CCS_VERSION"
  echo "https://github.com/kaitranntt/ccs"
  exit 0
fi

# Special case: help command (check BEFORE profile detection)
if [[ $# -gt 0 ]] && [[ "${1}" == "--help" || "${1}" == "-h" || "${1}" == "help" ]]; then
  shift  # Remove the help argument
  exec claude --help "$@"
fi

# Special case: install command (check BEFORE profile detection)
if [[ $# -gt 0 ]] && [[ "${1}" == "--install" ]]; then
  install_commands_and_skills
  exit $?
fi

# Smart profile detection: if first arg starts with '-', it's a flag not a profile
if [[ $# -eq 0 ]] || [[ "${1}" =~ ^- ]]; then
  # No args or first arg is a flag → use default profile
  PROFILE="default"
else
  # First arg doesn't start with '-' → treat as profile name
  PROFILE="${1}"
fi

# Check config exists
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "Error: Config file not found: $CONFIG_FILE"
  echo ""
  echo "Create ~/.ccs/config.json with your profile mappings."
  echo "See config/config.example.json for template."
  echo ""
  echo "Or reinstall: curl -fsSL ccs.kaitran.ca/install | bash"
  exit 1
fi

# Check jq installed
if ! command -v jq &> /dev/null; then
  echo "Error: jq is required but not installed"
  echo ""
  echo "Install jq:"
  echo "  macOS:   brew install jq"
  echo "  Ubuntu:  sudo apt install jq"
  echo "  Fedora:  sudo dnf install jq"
  exit 1
fi

# Validate profile name (alphanumeric, dash, underscore only)
if [[ "$PROFILE" =~ [^a-zA-Z0-9_-] ]]; then
  echo "Error: Invalid profile name. Use only alphanumeric characters, dash, or underscore."
  exit 1
fi

# Validate JSON syntax
if ! jq -e . "$CONFIG_FILE" &>/dev/null; then
  echo "Error: Invalid JSON in $CONFIG_FILE"
  exit 1
fi

# Validate config has profiles object
if ! jq -e '.profiles' "$CONFIG_FILE" &>/dev/null; then
  echo "Error: Config must have 'profiles' object"
  echo ""
  echo "See config/config.example.json for correct format"
  echo "Or reinstall: curl -fsSL ccs.kaitran.ca/install | bash"
  exit 1
fi

# Get settings path for profile (using --arg to prevent injection)
SETTINGS_PATH=$(jq -r --arg profile "$PROFILE" '.profiles[$profile] // empty' "$CONFIG_FILE")

if [[ -z "$SETTINGS_PATH" ]]; then
  echo "Error: Profile '$PROFILE' not found in $CONFIG_FILE"
  echo ""
  echo "Available profiles:"
  jq -r '.profiles | keys[]' "$CONFIG_FILE" 2>/dev/null | sed 's/^/  - /'
  exit 1
fi

# Expand ~ in path
SETTINGS_PATH="${SETTINGS_PATH/#\~/$HOME}"

# Validate settings file exists
if [[ ! -f "$SETTINGS_PATH" ]]; then
  echo "Error: Settings file not found: $SETTINGS_PATH"
  echo ""
  echo "Create the settings file or update the path in $CONFIG_FILE"
  exit 1
fi

# Shift profile arg only if first arg was NOT a flag
if [[ $# -gt 0 ]] && [[ ! "${1}" =~ ^- ]]; then
  shift
fi

# Execute claude with settings
exec claude --settings "$SETTINGS_PATH" "$@"
